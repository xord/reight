# 2024年度 Ruby アソシエーション開発助成金 中間報告

## 1. はじめに

この資料は、「2024 年度 Ruby アソシエーション開発助成金」制度で採択された「Processing Gem ベースの 2D レトロゲームエンジンの開発」についての中間報告書になります。

## 2. プロジェクト概要

昨年度採択された[CRuby 用 Processing Gem の本家 Processing との互換性向上に向けた取り組み](https://www.ruby.or.jp/ja/news/20240607)を基に、その成果物である Processing Gem をベースにして新たに 2Dレトロゲームエンジンの開発を行います。

このゲームエンジンは2Dのレトロゲームをターゲットとし、解像度や色数、オーディオ関連の仕様に意図的な制限を設けることでゲーム開発の複雑さを軽減し、初心者でも手軽にゲーム制作を始められる環境を提供することを目的としています。

Ruby と Processing を基盤とするこのゲームエンジンの開発により Ruby を活用したゲーム制作の幅を広げ、コミュニティの発展に貢献することを目指すものです。

## 3. 活動内容

本プロジェクト開始時に、まずは大枠の開発スケジュールを立てました。

1. スプライトエディターの開発
2. マップエディターの開発
3. 統合環境化
4. ゲーム実行機能の開発
5. オーディオ機能実装に足りてない機能を低レイヤーに実装
6. サウンドエディターの開発
7. ミュージックエディターの開発

中間報告の現時点では、一部を先送りした機能もありますがおおむね 5 の実装まで進んでおります。

## 4. 開発状況

ここからは開発項目個別の詳細と、その開発進捗状況を記載します。

### 4.1 スプライトエディターの開発

本ゲームエンジンは、2Dレトロゲームを主なターゲットとしており、ドット絵を基本としたゲーム制作を想定しています。そのため、開発の初期段階において、まずはドット絵制作に特化したエディターの開発に着手しました。

#### 4.1.1 機能説明

ここでは、スプライトエディターの画面を機能ごとに説明します。

<img src="https://gist.github.com/user-attachments/assets/faabd18d-3831-4c35-863e-6f15e0912920" width="600">

1. スプライト選択領域<br>
   8x8 や 16x16 などの大きさのスプライト画像を敷き詰めたスプライトシートを表示します。<br>
   選択した部分の画像をドット絵編集領域に表示し、描画ツールで編集できるるようにします。
2. ドット絵編集領域<br>
   スプライト選択領域で選択した範囲の画像を、5 の描画ツールを使って編集します。
3. 画面配置が未決定な機能を一時的に配置<br>
   UI 設計上ではまだ検討中ですが、機能としては実装したものを一時的にウィンドウ右端に集めています。今後の開発でそれぞれ適切な場所に移動予定です。
   1. ![image](https://gist.github.com/user-attachments/assets/d1e7db11-7623-475b-8178-dc0cc15c7b82) スプライトのサイズ選択<br>
      8、16、32 がそれぞれドットで 8x8、16x16、32x32 を表し、ドット絵編集領域の大きさを変更します。
   2. ![image](https://gist.github.com/user-attachments/assets/a6ccfdc9-e6aa-4ba4-a3c4-fbdad5da7934) ブラシサイズ選択<br>
      ブラシツールのブラシサイズを変更します。
   3. ![image](https://gist.github.com/user-attachments/assets/7fb10fc7-1121-4bea-aa80-3d3f8ed4df69) 物理演算の形状設定<br>
      スプライトは内部で形状を持ち、物理演算エンジンによる衝突判定に利用されます。<br>
      None、Rect、Circle がそれぞれ `物理演算なしスプライト`、`矩形形状スプライト`、`丸形状スプライト` となります。
   4. ![image](https://gist.github.com/user-attachments/assets/e4ae6336-6a62-4feb-9f98-7e0e67891d20) 物理演算の衝突の有無の設定<br>
      スプライトを物理演算の対象とする場合でも、他スプライトと接触判定はするものの形状として衝突はしない（すり抜ける）ようにするかどうか。`Sensor` にすると衝突はしなくなる。
4. カラーパレット<br>
   描画ツールで編集する際の色を選択します。<br>
   一旦この16色としていますが、このカラーパレットでゲームの印象が大きく影響を受けるため、今後検討予定です。（現状は PICO-8 のカラーパレットをそのまま採用）
5. 描画ツール
   1. ![image](https://gist.github.com/user-attachments/assets/ea8331ed-b785-4d7d-8e51-af0bfeb2458f) 選択ツール<br>
      ドット絵の一部を選択し、カット・コピーしたり移動したりできます
   2. ![image](https://gist.github.com/user-attachments/assets/b05f1179-37c8-4591-ab15-e16c85a3e207) ブラシ<br>
      クリックした位置に、選択した色でドットを描画します
   3. ![image](https://gist.github.com/user-attachments/assets/e6594831-3611-4a33-adb3-cdd4e51a23dd) 塗りつぶし<br>
      クリックした位置の周囲を、選択した色で塗りつぶします
   4. ![image](https://gist.github.com/user-attachments/assets/6bce9477-7d9c-440f-b2d3-a90974d4d387) 直線ツール<br>
      ドラッグした始点と終点を、選択した色で直線を描画します
   5. ![image](https://gist.github.com/user-attachments/assets/8ca9796b-ca0f-46d8-9e0e-e5db153c186d) 矩形（枠線）<br>
      ドラッグした始点と終点を矩形の左上と右下とし、選択した色で枠線を描画します
   6. ![image](https://gist.github.com/user-attachments/assets/007c936d-cca4-4d04-9293-775156d4ec31) 矩形（塗りつぶし）<br>
      ドラッグした始点と終点を矩形の左上と右下とし、選択した色で塗りつぶします
   7. ![image](https://gist.github.com/user-attachments/assets/5b2a8d99-49cc-4318-a58d-981db359cb33) 楕円（枠線）<br>
      ドラッグした始点と終点を楕円の左上と右下とし、選択した色で枠線を描画します
   8. ![image](https://gist.github.com/user-attachments/assets/9894931d-58fd-45bc-8204-9f29dbf6fd93) 楕円（塗りつぶし）<br>
      ドラッグした始点と終点を楕円の左上と右下とし、選択した色で塗りつぶします

#### 4.1.2 実装状況

中間報告の現時点では、レトロゲームのドット絵制作に必要となる基本的な機能を実装完了しております。

→ [現時点でのスプライトエディターのソースコード](https://github.com/xord/reight/blob/863589a67562c7388be053e570ba3c82cc5cf268/lib/reight/app/sprite.rb)

#### 4.1.3 今後の予定

スプライトエディターとして当初予定していた基本機能は一旦実装できています。ただ、実際にゲーム開発で利用していくと欲しくなる機能がありますので、今後も継続して機能追加していく予定です。

今後実装したい機能

- 左右、上下反転機能
- 曲線描画ツール
- 矩形以外の選択ツール
- レイヤー機能
- アニメーション関連機能

### 4.2 マップエディターの開発

スプライトエディターで作成したドット絵をマップチップとして配置し、RPG のフィールドやダンジョン等のマップを作成したり、横視点のプラットフォーマーゲーム向けのステージを作成する画面としてマップエディターも開発しました。

#### 4.2.1 機能説明

ここでは、マップエディターの画面を機能ごとに説明します。

<img src="https://gist.github.com/user-attachments/assets/83220a8b-749a-4b56-ace8-b659c15ad2ad" width="600">

1. スプライト選択領域<br>
   8x8 や 16x16 などの大きさのスプライト画像を敷き詰めたスプライトシートを表示します。<br>
   選択した部分の画像を、3 の描画ツールで 2 のマップ編集領域に配置できるようにします。
2. マップ編集領域<br>
   1 のスプライト選択領域で選択したマップチップを、3 の描画ツールで配置してマップを編集します。
4. スプライトのサイズ選択<br>
   8、16、32 がそれぞれドットで 8x8、16x16、32x32 を表し、配置するマップチップ大きさを変更します。
3. 描画ツール
   1. ![image](https://gist.github.com/user-attachments/assets/b05f1179-37c8-4591-ab15-e16c85a3e207) ブラシ<br>
      マップ編集領域のクリックした位置に、選択したマップチップを配置します
   2. ![image](https://gist.github.com/user-attachments/assets/6bce9477-7d9c-440f-b2d3-a90974d4d387) 直線ツール<br>
      マップ編集領域のドラッグした始点と終点に、選択したマップチップを直線状に配置します
   3. ![image](https://gist.github.com/user-attachments/assets/8ca9796b-ca0f-46d8-9e0e-e5db153c186d) 矩形（枠線）<br>
      マップ編集領域のドラッグした始点と終点を矩形の左上と右下とし、選択したマップチップを枠線状に配置します
   4. ![image](https://gist.github.com/user-attachments/assets/007c936d-cca4-4d04-9293-775156d4ec31) 矩形（塗りつぶし）<br>
      マップ編集領域のドラッグした始点と終点を矩形の左上と右下とし、選択したマップチップを敷き詰めるように配置します

#### 4.2.2 実装状況

中間報告の現時点では、2Dレトロゲームのマップ・ステージ制作に必要な最低限の機能を実装完了しております。

→ [現時点でのマップエディターのソースコード](https://github.com/xord/reight/blob/863589a67562c7388be053e570ba3c82cc5cf268/lib/reight/app/map.rb)

#### 4.2.3 今後の予定

マップエディターは、当初予定していた想定未満の、必要最低限の機能のみを実装しています。開発スケジュール的に優先度をさげた機能もいくつかありますので、今後も継続して実装していきたいと思っています。

- 選択ツール
- 拡大縮小機能
- レイヤー機能
- 不動スプライト統合機能（負荷軽減のため）

### 4.3 統合環境化

スプライトエディターとマップエディターを実装した時点では、ゲームエンジン起動時にはどちらかの画面を固定で表示するしかない状態だったため、ゲーム開発の統合開発環境とするために各エディター画面を切り替えながら利用できるようにしました。

こちらは実際にスプライトエディターとマップエディターを切り替えて使う様子です。<br>
→ https://x.com/tokujiros/status/1863607102314631666

#### 4.3.1 機能説明

画面上部にナビゲーション用のバーを作り、そこに画面切り替えボタンを配置しました。

<img src="https://gist.github.com/user-attachments/assets/1eefafa4-8cf4-436b-9979-9252896181c8" width="600">

1. エディター切り替えボタン
   1. ![image](https://gist.github.com/user-attachments/assets/371a3318-8131-4bde-8e3e-675d0b41a262) ゲーム実行画面<br>
      ソースコードやドット絵、マップデータなどを利用してゲームの実行を開始します。
   2. ![image](https://gist.github.com/user-attachments/assets/9a18a89f-22dc-4478-a210-8c08479f1c6a) スプライトエディター画面<br>
      スプライトエディター画面に切り替えます。
   3. ![image](https://gist.github.com/user-attachments/assets/ecf99575-d30b-4b33-bd57-df71ddf80c48) マップエディター画面<br>
      マップエディター画面に切り替えます。
   4. ![image](https://gist.github.com/user-attachments/assets/a5ee0fcb-c7d3-42ae-84af-ac35ab558635) サウンドエディター画面<br>
      サウンドエディター画面（未実装）に切り替えます。
   5. ![image](https://gist.github.com/user-attachments/assets/de8a06e9-092b-42b1-8e17-10c9c0fd67d7) ミュージックエディター<br>
      ミュージックエディター画面（未実装）に切り替えます。

#### 4.3.2 実装状況

各画面切り替え用のツールバーを Navigator クラスとして実装完了しております。

→ [画面切り替え部のソースコード](https://github.com/xord/reight/blob/863589a67562c7388be053e570ba3c82cc5cf268/lib/reight/app/navigator.rb)

### 4.4 ゲーム実行機能の開発

ゲームエンジンを統合開発環境として設計するにあたり、ゲーム実行ボタンを押すたびにソースコードを初期状態から実行できる仕組みが必要です。このため、ゲームの実行開始時には実行環境を初期化し、前回の実行状態を引き継がないよう設計しました。具体的には、無名モジュールのインスタンスを実行コンテキストとして利用し、その中でソースコードを eval することで、各実行ごとに状態を完全に分離しています。

<img src="https://gist.github.com/user-attachments/assets/1fc538ca-18ca-490b-b814-7a6845c6be49" width="600">

#### 4.4.1 実装状況

ゲーム実行画面を、Runner クラスとして実装完了しております。

→ [ゲーム実行画面のソースコード](https://github.com/xord/reight/blob/863589a67562c7388be053e570ba3c82cc5cf268/lib/reight/app/runner.rb)

#### 4.4.2 今後の予定

ソースコードは外部テキストエディターで編集することを想定していますので、ファイルが更新されたら自動で再実行、または実行状態のままコードを反映する仕組みを導入したいと思っています。これが実現できると、ゲーム開発の効率が大幅に向上するのでぜひ実現したいところです。

またゲーム実行コンテキスト分離の実装部分は、現状の実装だといろいろと弊害があります。ユーザー定義クラス内でユーザー定義関数が呼べないなどを、method_missing を活用するなど苦しい工夫で回避しています。

ここは今後 Ruby 本体に Namespace 機能が導入されれば、シンプルに実装し直すことができるかもしれないと期待しています。

### 4.5 オーディオ機能実装に足りてない機能を低レイヤーに実装

グラフィックス周りとは違い、サウンドエディターとミュージックエディターの開発には事前に低レイヤーの機能追加が必要でした。

低レイヤーに実装しているオーディオ関連の機能は、サイン波や矩形波、または任意の .wav ファイルなどを鳴らすまでしかできておらず、複数の音を組み合わせて新しく効果音を作成したり、音楽を鳴らしたりする機能が足りていませんでした。

このため低レイヤー部分にシーケンサークラスを追加実装しました。

#### 4.5.1 機能説明

Sequencer クラスのインターフェイスはシンプルです。以下のように利用します。

```
seq = Sequencer.new                      # シーケンサーオブジェクト作成
seq.add(Oscillator.new(freq: 440), 0, 1) # 再生開始から0秒目にラの音を1秒再生
seq.add(Oscillator.new(freq: 440), 2, 1) # 再生開始から2秒目にラの音を1秒再生
seq.add(Oscillator.new(freq: 440), 4, 1) # 再生開始から4秒目にラの音を1秒再生
Sound.new(seq, 5).play                   # シーケンサーオブジェクト自体を再生
```

シーケンサークラスに音と時間を指定して複数追加することで、指定時間通りに音を順に鳴らすことができるようになりました。

こちらは Sequencer クラスの動作確認のため、[簡易的な MML コンパイラー](https://gist.github.com/xord/6d0400193cdafe0600f1765880414729)を実装し短い音楽を鳴らしている様子です。<br>
 → https://x.com/tokujiros/status/1871253335141130653

#### 4.5.2 実装状況

C++ の低レイヤーライブラリに Sequencer クラスを実装しました。

→ [Sequencer クラスのソースコード](https://github.com/xord/beeps/blob/8820769f41e30528f29a717aa877f8706af3ffb6/src/sequencer.cpp)

## 5. 前半の成果

中間報告時点の成果物としてのソースコードは [GitHub](https://github.com/xord/reight) にアップロードしています。

実際に利用している様子を動画にしたものも X(Twitter) にポストしていますのでご参考ください。<br>
https://x.com/tokujiros/status/1877151551405298103
<img src="https://gist.github.com/user-attachments/assets/86c09da3-7a41-40c4-ada9-94319195c399" width="600">

## 5. 今後の開発スケジュールについて

マップエディターの一部機能は未実装ですが、それ以外は概ねスケジュール通りに進行しています。
現時点で、本エンジンを使用して簡単なゲームを作成し実行できる状態に到達しましたので、このあと一旦アルファバージョンとして gem として公開する予定です。

中間報告以降の後半では、予定通りサウンドエディターとミュージックエディターの開発を進めるとともに、ゲーム開発統合環境としての機能強化にも引き続き取り組む予定です。